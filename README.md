# 📋 신용카드 이상거래 탐지 모델을 위한 Feature Engineering 프로젝트

본 프로젝트는 신용카드 거래 이력 데이터를 기반으로

사기 거래 여부를 예측하는 이상탐지 모델을 위한 Feature Engineering을 수행하며,  
신용카드 번호 단위로 개인의 행동 패턴을 반영한 파생 피처를 구성해 모델 학습에 적합한 데이터로 정제하는 것을 목표로 합니다.

프로젝트 진행 후, 보다 유의미한 정보를 도출해내기 위해 정제된 데이터를 바탕으로 사기 거래만 필터링한 후, 주요 파생 피처들의 수치적 분포를 분석하여 **사기 거래의 구조적 특성**을 도출해 보았습니다.

> 🛠️ 사용 환경: Python, Pandas, Jupyter Notebook

> 정규화된 파생 피처로 본 사기 거래 건 분석의 자세한 진행 과정은 [velog.io/@jul-ee](https://velog.io/@jul-ee/DS-%EB%B9%84%EC%A0%95%EC%A0%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0-Feature-Engineering-w.fraud)에서 확인하실 수 있습니다.

<br>
<br>

## 📂 사용 데이터셋

해당 데이터셋은 개인 단위의 카드 결제 이력과 거래에 관련된 다양한 정보를 포함하고 있으며, 각 거래가 사기 거래인지(`is_fraud`) 여부가 종속변수로 작용한다.

각 행은 하나의 결제 거래를 의미하고, `cc_num`을 기준으로 같은 사용자의 여러 거래를 추적할 수 있어, 사용자 행동 기반 이상탐지 피처 생성에 적합하다.

- 주요 컬럼: `cc_num`, `trans_date_trans_time`, `amt`, `merchant`, `category`, `lat`, `long`, `merch_lat`, `merch_long`, `dob`, 
`first`, `last`, `gender`, `is_fraud`

<br>
<br>

## 분석 프로세스

|  | 처리 내용 | 설명 및 인사이트 |
| --- | --- | --- |
| 1 | 데이터 확인 및 불필요한 컬럼 제거 | 사기 건이 0.2%로 아주 적은 불균형 데이터임을 확인. 분석에 불필요하거나 중복되는 컬럼 제거 |
| ↓ | |
| 2 | 결제 금액 feature 분석 | 카드번호 단위로 거래 금액의 z-score를 도출해, 평소 행동 패턴에서 벗어난 이상 거래로 탐지 가능 |
| ↓ | |
| 3 | 결제 시각 feature 분석 | 거래 시각을 기반으로 시간대를 범주화하고, 카드 번호별/시간대별 사용 비율을 파생하여 행동 패턴을 정량화 |
| ↓ | |
| 4 | 거리 기반 feature 분석 | 고객과 상점 간 거리 계산으로 z-score를 도출해, 평소 행동 패턴에서 벗어난 이상 금액 탐지 가능 |
| ↓ | |
| 5 | 나이 파생 feature 생성 | 생년월일과 거래 시점을 비교해 고객의 나이 계산 → 고객 특성에 따른 사기 위험도 분석에 활용 가능 |
| ↓ | |
| 6 | 범주형 변수 인코딩 | 범주형 데이터를 One-Hot Encoding으로 처리하여 모델이 인식 가능한 형태로 변환 |


<br>

## 파생 Feature

| Feature | 설명 |
|--------------|------|
| `z_amt` | 카드번호 기준 결제금액 z-score |
| `cat_amt_z` | 동일 카테고리 내 거래 금액의 z-score |
| `hour_cat` | 결제 시간대 (ex. 새벽, 오전 등) |
| `hour_perc` | 해당 거래 시간대의 고객 거래 비중 |
| `distance` | 고객 ↔ 상점 간 거리 |
| `dist_z` | 고객 ↔ 상점 간 거리 z-score |
| `age` | 고객 나이 |
| `category_xx`, `gender_xx` | 인코딩된 범주형 변수들 |

<br>
<br>

## Feature Engineering 프로세스

**[1] 결제 금액 feature 분석**
- 카드번호(`cc_num`) 단위로 평균 및 표준편차 계산
- 이상 거래 탐지를 위해 z-score(`z_amt`) 도출
- `category`까지 고려한 이중 그룹 기준으로 재계산

<br>

**[2] 결제 시각 feature 분석**
- `hour` 파생 → 시간대(`hour_cat`) 범주화
- z-score를 도출하면 컴퓨터가 인식하는 숫자의 한계가 있기 때문에 카드번호별/시간대별 거래 비율(`hour_perc`) 계산
- 고객별 시간대 거래 패턴을 정량화
- 이전 거래와의 날짜 차이를 구하는 등 이상 탐지가 가능한 피처 분석

<br>

**[3] 거리 기반 feature 분석**
- 고객 위치 ↔ 상점 위치 간 거리 계산
- 카드번호 단위 거리 평균 및 표준편차 → z-score(`z_dist`) 생성
- 거리 이상 탐지 가능

<br>

**[4] 나이 파생 feature 생성**
- 생년월일(`dob`)에서 연도만 추출하여 나이 개념으로 사용
- 고객 특성에 따른 사기 위험도 분석에 활용 가능

<br>

**[5] 범주형 인코딩**
- `category`, `gender` 등 범주형 변수를 One-Hot Encoding 처리
- 이후 적용할 이상거래 탐지 모델이 인식 가능한 형태로 변환 및 데이터 정리

<br>
<br>

## 정규화된 파생 피처로 본 사기 거래 건 분석

Feature Engineering을 수행한 전체 거래 데이터(`cc_df`)에서

`is_fraud == 1`인 사기 거래만 필터링하여 `fraud_df`를 생성한 뒤 테이블을 병합하여

정제된 주요 파생 피처 다섯 가지(`amt_z`, `cat_amt_z`, `hour_perc`, `distance`, `dist_z`)를 기준으로 결과 분석을 수행하였다.

<br>

사기 거래 건들만 따로 모아 분석한 이유는 다음과 같다.

- 정규화된 파생 피처들(amt_z, cat_amt_z, hour_perc, distance, dist_z)이 전체 거래를 기준으로 만들어졌기 때문에
 → **사기 거래가 이 기준에서 얼마나 벗어나는지** 살펴볼 수 있음

- 이를 통해 머신러닝 모델 학습 전, 정상 거래 대비 사기 거래의 특징 및 분포를 수치로 파악

<br>

### 주요 분석 결과

1) &nbsp;amt_z: &nbsp;사용자 기준 금액 이상 탐지  
- 사기 거래 평균: &nbsp;**2.931**
- 전체 거래 평균: &nbsp;**0.000**
- 사기 거래 중 거래 금액의 `z-score > 2` 비율: &nbsp;**약 50.96%**
    
2) &nbsp;cat_amt_z: &nbsp;카테고리 기준 금액 이상 탐지
- 사기 거래 평균: &nbsp;**3.134**
- 전체 거래 평균: &nbsp;**0.000**

3) &nbsp;`hour_perc`: &nbsp;고객별 시간대 거래 비중
- 사기 거래 평균: &nbsp;**0.228**
- 전체 거래 평균: &nbsp;**0.280**,
- 23.47% (292건)의 사기 거래가 `hour_perc ≤ 0.2`에 해당
    
4) &nbsp;distance: &nbsp;고객 ↔ 상점 간 거리 
- 사기 거래 평균 거리: &nbsp;**76.754 km**
- 전체 거래 평균 거리: &nbsp;**76.372 km**
- 평균 외에도 분포가 유사한 것을 확인

5) &nbsp;dist_z: &nbsp;사용자 기준 거리 이상도
- 사기 거래 평균: &nbsp;**0.015**
- 전체 거래 평균: &nbsp;**0.000**,
- 평균 외에도 분포가 유사한 것을 확인
- `z-score > 2` 이상 거래 비중은 매우 낮음 (0.56%)

<br>

사기 거래는 단일 피처 수준에서도 충분히 이상 신호를 보이는 경우가 많았고, 특히 `amt_z`, `cat_amt_z`, `hour_perc`는 각각의 조건만으로도 충분한 설명력을 보였다.
이들이 결합되면, 단일 기준을 넘어서는 강한 이상 패턴으로 드러나는 경우도 확인할 수 있었다.

반대로 개별 통계 차이가 작아 보이는 피처도 다른 변수와의 조합 속에서 충분히 의미를 가질 수 있음을 확인할 수 있었다.

<br>
<br>

## 💡 인사이트 및 결론

신용카드 사기 거래 탐지는 불균형 데이터(imbalanced data) 문제를 수반한다.  
- 전체 거래 중 사기 거래(is_fraud = 1)가 차지하는 비율은 극히 적으며, 이는 모델이 정상 거래만 학습하고 사기 거래를 분류하지 못하는 문제로 이어질 수 있다. 
이를 해결하기 위해 SMOTE와 같은 오버 샘플링 또는 언더 샘플링 고려할 수 있으며, 본 프로젝트에서는 우선 학습에 앞서 정제된 피처를 통해 분류 기준을 명확히 만드는 데 집중하였다.

개인별 평소 거래 금액 패턴에서 벗어난 이상 지출은 사기 가능성이 높다.  
- 카드번호(cc_num)를 기준으로 각 사용자의 평균 거래 금액과 표준편차를 산출하고, z-score로 이상 거래 여부를 정량화하였다.
이 방식은 단순한 금액 기준이 아닌 개인 기준의 비정상 거래 감지에 효과적이며, 특히 금액이 작아도 개인 기준에서 벗어났다면 이상 탐지의 근거가 될 수 있음을 보여준다.

시간대별 거래 비율은 카드 사용자마다 고유한 패턴이 존재한다.  
- 거래 시각에서 파생한 시간대(hour_cat)는 사용자 고유의 소비 습관을 반영한다.
카드번호별로 시간대별 거래 비율(hour_perc)을 계산하여 사용자의 일반적인 활동 시간대를 정량화하고, 이를 벗어나는 거래를 이상으로 감지할 수 있도록 했다.
이는 단순한 시각 정보 활용을 넘어 사용자 행동 특성 기반 이상탐지에 실질적으로 기여하는 피처로 활용 가능하다.

거리 기반 분석은 사용자의 활동 범위와 이탈 감지를 가능하게 한다.  
- 고객 위치 ↔ 상점 위치 간 거리 계산을 통해 z_dist를 생성하고, 사용자 이동 반경을 벗어난 거래를 사기로 의심할 수 있다. 특히 일정 지역 내 소비에 익숙한 사용자의 경우, 갑작스러운 장거리 거래는 이상 거래 시그널이 될 수 있다.

단일 피처만으로 탐지되지 않던 거래들도, 여러 기준에서 동시에 벗어날 경우 사기 가능성이 높아진다.
- 모델 설계 시 이러한 다중 이상 조건을 조합하는 방식은 탐지 성능 향상에 실질적인 도움을 줄 수 있다.

<br>

사용자의 일반적인 소비 패턴에서 벗어난 거래를 중심으로 파생 피처를 설계하였고, 이를 통해 실제 모델이 학습 가능하도록 데이터를 정제할 수 있었다.
여러 기준에서 동시에 평소와 다른 패턴이 나타나는 거래의 특징을 바탕으로 사기 거래를 더 정확히 탐지할 수 있는 기반을 마련해 보는 경험이 되었다.

<br>

> 본 프로젝트는 사용자 행동 기반의 이상 거래 탐지를 목표로, 피처 엔지니어링과 수치 기반 분포 분석을 통해 실제 모델 학습을 위한 데이터를 정제하는 데 중점을 두었습니다.

<br>
